---
- include_vars:
    file: user_secrets.yml
    name: user_passwords
- name: Create user profiles.
  user:
    groups: wheel
    name: "{{ item.username }}"
    shell: /bin/bash
    uid: "{{ item.uid }}"
    password: "{{ user_password }}"
    state: present
  register: u
- name: Create .ssh folder.
  file:
    state: directory
    path: "/home/{{ item.username }}/.ssh"
    owner: "{{ item.username }}"
    group: wheel
    mode: 0700
- name: Copy ssh public key.
  lineinfile:
    path: "/home/{{ item.username }}/.ssh/authorized_keys"
    create: yes
    line: "{{ public_key }}"
- assert:
    that: "u.home is defined"
    success_msg: "User successfully created."
    fail_msg: "User home folder not found."
